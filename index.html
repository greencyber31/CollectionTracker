<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collection Tracker (Offline)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CollectionTracker">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f1115;
            --text-primary: #ededed;
            --text-secondary: #a0a0a0;
            --accent: #6c5ce7;
            --accent-hover: #5649c0;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --card-hover: rgba(255, 255, 255, 0.06);
            --font-main: 'Outfit', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
        }

        body {
            /* iOS Safe Area */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Background Blobs */
        .background-glob {
            position: fixed;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(108, 92, 231, 0.15) 0%, rgba(0, 0, 0, 0) 70%);
            top: -200px;
            left: -200px;
            z-index: -1;
            pointer-events: none;
        }

        .glob-2 {
            top: auto;
            bottom: -200px;
            left: auto;
            right: -200px;
            background: radial-gradient(circle, rgba(231, 92, 168, 0.1) 0%, rgba(0, 0, 0, 0) 70%);
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 50px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 24px;
            color: var(--accent);
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo h1 span {
            color: var(--accent);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #a29bfe);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 1.1em;
            font-family: 'Outfit', sans-serif;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(108, 92, 231, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.2em;
            pointer-events: none;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .loading-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        /* Cards */
        .item-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .item-card:hover {
            background: var(--card-hover);
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .card-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background-color: #1a1d24;
        }

        .card-content {
            padding: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-price {
            background: rgba(108, 92, 231, 0.15);
            color: #a29bfe;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .card-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .delete-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #FF4757;
        }

        .item-card:hover .delete-btn {
            opacity: 1;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .glass-panel {
            background: #161920;
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.active .glass-panel {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .btn-icon:hover {
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 12px 16px;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-submit {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-submit:hover {
            background: var(--accent-hover);
        }

        /* File Upload */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-upload-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-custom-label {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--glass-border);
            padding: 12px;
            border-radius: 12px;
            color: var(--text-secondary);
            justify-content: center;
            transition: all 0.2s;
        }

        .file-upload-wrapper:hover .file-custom-label {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        /* View Modal Specifics */
        .view-panel {
            max-width: 800px;
        }

        .view-body {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .view-image-container {
            width: 100%;
            max-height: 400px;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--glass-border);
        }

        .view-image-container img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }

        .view-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .view-price-tag {
            align-self: flex-start;
            background: var(--accent);
            color: white;
            font-size: 24px;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .view-description label {
            display: block;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .view-description p {
            font-size: 16px;
            line-height: 1.6;
            color: #e0e0e0;
            white-space: pre-wrap;
        }

        @media (min-width: 768px) {
            .view-body {
                flex-direction: row;
                align-items: flex-start;
            }

            .view-image-container {
                flex: 3;
            }

            .view-details {
                flex: 2;
            }
        }

        /* Group Headers */
        .group-container {
            margin-bottom: 40px;
        }

        .group-header {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .group-header:hover {
            color: var(--accent);
        }

        .group-header i.fa-chevron-down {
            margin-left: auto;
            font-size: 16px;
            transition: transform 0.3s;
        }

        .group-header.collapsed i.fa-chevron-down {
            transform: rotate(-90deg);
        }

        .group-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            transition: all 0.3s ease;
            max-height: 5000px;
            /* Arbitrary large height */
            opacity: 1;
            overflow: hidden;
        }

        .group-items.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            gap: 0;
        }

        .group-header i {
            color: var(--accent);
            font-size: 20px;
        }

        .group-header i {
            color: var(--accent);
            font-size: 20px;
        }

        /* Image Previews */
        .image-previews {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            margin-top: 15px;
            padding-bottom: 5px;
        }

        .preview-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .preview-container {
            position: relative;
        }

        .remove-thumb {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #FF4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        /* Gallery in View Modal */
        .gallery-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            overflow-x: auto;
        }

        .gallery-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            border: 2px solid transparent;
        }

        .gallery-thumb.active {
            opacity: 1;
            border-color: var(--accent);
        }

        /* Dropdown Menu */
        .settings-container {
            position: relative;
            margin-right: 10px;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #1a1d24;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 8px;
            min-width: 180px;
            display: none;
            flex-direction: column;
            gap: 5px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            margin-top: 10px;
        }

        .dropdown-menu.active {
            display: flex;
        }

        .dropdown-item {
            background: none;
            border: none;
            color: var(--text-primary);
            padding: 12px 16px;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            transition: background 0.2s;
            width: 100%;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .dropdown-item.delete-option {
            color: #FF4757;
        }

        .dropdown-item.delete-option:hover {
            background: rgba(255, 71, 87, 0.1);
        }
    </style>
</head>

<body>
    <div class="background-glob"></div>
    <div class="background-glob glob-2"></div>

    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fa-solid fa-cube"></i>
                <h1>Collection<span>Tracker</span></h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="settings-btn" class="btn-primary" style="padding: 10px 15px;">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button id="add-btn" class="btn-primary">
                    <i class="fa-solid fa-plus"></i> Add Item
                </button>
            </div>
        </header>

        <div class="search-container">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="text" id="search-input" class="search-input" placeholder="Search items...">
        </div>

        <div id="back-nav-container" style="display: none; padding: 0 20px; margin-bottom: 10px;">
            <button id="back-to-groups-btn" class="btn-primary"
                style="padding: 8px 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-secondary);">
                <i class="fa-solid fa-arrow-left"></i> Back to Collections
            </button>
        </div>

        <main>
            <div id="items-grid" class="items-grid">
                <div class="loading-state">
                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                    <p>Loading your collection...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Item Modal -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h2>Add New Item</h2>
                <button id="close-modal" class="btn-icon"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="add-item-form">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" required placeholder="e.g. Vintage Camera">
                </div>

                <div class="form-group">
                    <label for="price">Price (₱)</label>
                    <input type="number" id="price" name="price" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="description">Description (Optional)</label>
                    <textarea id="description" name="description" rows="3" placeholder="Item details..."></textarea>
                </div>

                <div class="form-group">
                    <label for="group">Group / Category (Optional)</label>
                    <input type="text" id="group" name="group" list="group-suggestions"
                        placeholder="e.g. Cameras, Lenses">
                    <datalist id="group-suggestions"></datalist>
                </div>

                <div class="form-group">
                    <label>Images (Max 5 Uploads + 5 Photos)</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <!-- Upload Button -->
                        <div class="file-upload-wrapper" style="flex: 1;">
                            <input type="file" id="image-upload" accept="image/*" multiple>
                            <div class="file-custom-label" style="text-align: center; height: 100%;">
                                <i class="fa-solid fa-images"></i>
                                <span>Upload Files</span>
                            </div>
                        </div>
                        <!-- Camera Button -->
                        <div class="file-upload-wrapper" style="flex: 1;">
                            <input type="file" id="camera-upload" accept="image/*" capture="environment">
                            <div class="file-custom-label" style="text-align: center; height: 100%;">
                                <i class="fa-solid fa-camera"></i>
                                <span>Take Photo</span>
                            </div>
                        </div>
                    </div>
                    <div id="image-previews" class="image-previews"></div>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-submit">Add into Collection</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h2>Data Management</h2>
                <button id="close-settings-modal" class="btn-icon"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="view-body" style="flex-direction: column; gap: 20px;">
                <p style="color: var(--text-secondary); line-height: 1.5;">
                    Backup your collection to a file or restore from a previous backup.
                    <br><br>
                    <strong style="color: #FF4757;">Note:</strong> Restoring will add items to your current list. It
                    will not delete existing items.
                </p>

                <button id="export-btn" class="btn-primary" style="width: 100%; justify-content: center;">
                    <i class="fa-solid fa-download"></i> Export Backup File
                </button>

                <div style="width: 100%; height: 1px; background: var(--glass-border); margin: 10px 0;"></div>

                <div class="file-upload-wrapper">
                    <input type="file" id="import-file" accept=".json">
                    <div class="file-custom-label" style="text-align: center;">
                        <i class="fa-solid fa-upload"></i>
                        <span id="import-label">Select Backup File to Restore...</span>
                    </div>
                </div>

                <button id="import-btn" class="btn-submit" disabled style="opacity: 0.5; cursor: not-allowed;">
                    Restore Collection
                </button>

                <div style="width: 100%; height: 1px; background: var(--glass-border); margin: 10px 0;"></div>

                <div style="margin-top: 10px;">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">Troubleshooting</h3>
                    <button id="force-update-btn" class="btn-primary"
                        style="width: 100%; justify-content: center; background: rgba(255, 71, 87, 0.2); border: 1px solid rgba(255, 71, 87, 0.5); color: #FF4757;">
                        <i class="fa-solid fa-rotate-right"></i> Force Update / App Refresh
                    </button>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                        Use this if features are missing or the app is behaving strangely. It will reload the latest
                        version.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- View Item Modal -->
    <div id="view-modal" class="modal-overlay">
        <div class="modal-content glass-panel view-panel">
            <div class="modal-header">
                <h2 id="view-name">Item Name</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="settings-container">
                        <button id="view-settings-btn" class="btn-icon">
                            <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>
                        <div id="view-options-dropdown" class="dropdown-menu">
                            <button id="view-edit-btn" class="dropdown-item">
                                <i class="fa-solid fa-pen" style="width: 20px;"></i> Edit Item
                            </button>
                            <button id="view-delete-btn" class="dropdown-item delete-option">
                                <i class="fa-solid fa-trash" style="width: 20px;"></i> Delete Item
                            </button>
                        </div>
                    </div>
                    <button id="close-view-modal" class="btn-icon"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="view-body">
                <div class="view-image-container">
                    <img id="view-image" src="" alt="Item Image">
                </div>
                <div class="view-details">
                    <div class="view-price-tag" id="view-price">$0.00</div>
                    <div class="view-description">
                        <label>Description</label>
                        <p id="view-description">No description.</p>
                    </div>
                    <div class="view-description" id="view-group-container" style="display: none;">
                        <label>Group</label>
                        <p id="view-group"></p>
                    </div>

                    <!-- Gallery Thumbnails -->
                    <div id="view-gallery" class="gallery-container"></div>

                    <!-- View Actions -->

                </div>
            </div>
        </div>
    </div>

    <script>
        // DB Config
        const DB_NAME = 'CollectionDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'items';
        let db;

        // Init DB
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = (event) => {
            console.error("Database error: " + event.target.errorCode);
            alert("Failed to open local database.");
        };

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            const objectStore = db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            initializeApp();
        };

        function initializeApp() {
            const modal = document.getElementById('modal');
            const viewModal = document.getElementById('view-modal');
            const settingsModal = document.getElementById('settings-modal');

            const addBtn = document.getElementById('add-btn');
            const settingsBtn = document.getElementById('settings-btn');

            const closeModalBtn = document.getElementById('close-modal');
            const closeViewModalBtn = document.getElementById('close-view-modal');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal');

            const addItemForm = document.getElementById('add-item-form');
            const itemsGrid = document.getElementById('items-grid');



            // Image Input Elements
            const uploadInput = document.getElementById('image-upload');
            const cameraInput = document.getElementById('camera-upload');
            const previewContainer = document.getElementById('image-previews');



            let currentImages = []; // Stores Base64 strings
            let editingId = null; // Track if we are editing an existing item
            let editingCreated = null; // Track original creation date
            let activeGroup = null; // null = Dashboard, string = Specific Group Name

            // Search Vars
            let allItems = []; // Cache for filtering
            const searchInput = document.getElementById('search-input');

            // Settings Elements
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');
            const importLabel = document.getElementById('import-label');

            // Load initial data
            loadItems();

            // Search Logic
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allItems.filter(item =>
                    item.name.toLowerCase().includes(term) ||
                    (item.group && item.group.toLowerCase().includes(term))
                );
                renderItems(filtered);
            });

            // Modal Controls
            addBtn.addEventListener('click', () => {
                editingId = null; // Reset to Add Mode
                editingCreated = null;
                addItemForm.reset();
                document.querySelector('#modal h2').textContent = 'Add New Item';
                addItemForm.querySelector('.btn-submit').textContent = 'Add into Collection';
                currentImages = [];
                renderPreviews();
                modal.classList.add('active');
            });

            closeModalBtn.addEventListener('click', () => {
                modal.classList.remove('active');
            });

            closeViewModalBtn.addEventListener('click', () => {
                viewModal.classList.remove('active');
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });

            // Settings Modal Controls
            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) settingsModal.classList.remove('active');
            });

            viewModal.addEventListener('click', (e) => {
                if (e.target === viewModal) {
                    viewModal.classList.remove('active');
                }
            });

            // Settings Dropdown Logic
            const settingsBtnView = document.getElementById('view-settings-btn');
            const dropdownView = document.getElementById('view-options-dropdown');

            settingsBtnView.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownView.classList.toggle('active');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!settingsBtnView.contains(e.target) && !dropdownView.contains(e.target)) {
                    dropdownView.classList.remove('active');
                }
            });

            // --- Image Handling Logic ---

            function handleImageSelect(e, source) {
                const files = Array.from(e.target.files);
                if (!files.length) return;

                // Enforce Limits
                const uploadCount = currentImages.filter(img => img.source === 'upload').length;
                const cameraCount = currentImages.filter(img => img.source === 'camera').length;

                files.forEach(file => {
                    // Check limits based on source
                    if (source === 'upload' && uploadCount >= 5) {
                        alert('Max 5 uploaded images allowed.');
                        return;
                    }
                    if (source === 'camera' && cameraCount >= 5) {
                        alert('Max 5 camera photos allowed.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imgData = {
                            data: event.target.result,
                            source: source,
                            id: Date.now() + Math.random() // Temp ID for removal
                        };
                        currentImages.push(imgData);
                        renderPreviews();
                    };
                    reader.readAsDataURL(file);
                });

                // Reset inputs to allow selecting same file again
                e.target.value = '';
            }

            uploadInput.addEventListener('change', (e) => handleImageSelect(e, 'upload'));
            cameraInput.addEventListener('change', (e) => handleImageSelect(e, 'camera'));

            function renderPreviews() {
                previewContainer.innerHTML = '';
                currentImages.forEach((img, index) => {
                    const div = document.createElement('div');
                    div.className = 'preview-container';
                    div.innerHTML = `
                        <img src="${img.data}" class="preview-thumb">
                        <button class="remove-thumb" onclick="removeImage(${index})">×</button>
                    `;
                    previewContainer.appendChild(div);
                });
            }

            window.removeImage = (index) => {
                currentImages.splice(index, 1);
                renderPreviews();
            };

            // Form Submit Logic
            addItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const submitBtn = addItemForm.querySelector('.btn-submit');
                submitBtn.textContent = 'Adding...';
                submitBtn.disabled = true;

                try {
                    // Collect just the data strings
                    const finalImages = currentImages.map(img => img.data);

                    const newItem = {
                        name: document.getElementById('name').value,
                        price: parseFloat(document.getElementById('price').value),
                        description: document.getElementById('description').value,
                        group: document.getElementById('group').value.trim(),
                        images: finalImages, // Save array
                        image: finalImages.length > 0 ? finalImages[0] : null, // Legacy support for main cover
                        created: editingId ? editingCreated : new Date().toISOString() // Keep original date if editing
                    };


                    const transaction = db.transaction([STORE_NAME], "readwrite");
                    const objectStore = transaction.objectStore(STORE_NAME);

                    let request;
                    if (editingId) {
                        newItem.id = editingId;
                        newItem.created = new Date().toISOString(); // Update timestamp? Or keep original? Let's keep original logic simpler for now or maybe strictly preserve. 
                        // Actually, let's preserve the original creation date if possible, but 'put' replaces the object. 
                        // To do this perfectly we'd need to fetch the original item first, but for now let's just use the current logic which might overwrite 'created' if we don't handle it.
                        // I added 'editingId ? undefined : ...' above to avoiding overwriting if I could reading it back, but I am not reading it back here.
                        // Let's just update modified time or keep it simple.

                        // FIX: We need to preserve the ID.
                        request = objectStore.put(newItem);
                    } else {
                        request = objectStore.add(newItem);
                    }

                    request.onsuccess = () => {
                        modal.classList.remove('active');
                        addItemForm.reset();
                        currentImages = []; // Clear array
                        renderPreviews(); // Clear UI
                        submitBtn.textContent = 'Add into Collection';
                        submitBtn.disabled = false;

                        loadItems(); // Refresh the grid to show changes (especially for edit/group changes)
                    };

                    transaction.onerror = () => {
                        alert('Failed to save to database');
                        submitBtn.textContent = 'Add into Collection';
                        submitBtn.disabled = false;
                    };

                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                    submitBtn.textContent = 'Add into Collection';
                    submitBtn.disabled = false;
                }
            });

            function loadItems() {
                const transaction = db.transaction([STORE_NAME], "readonly");
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll(); // get all items
                request.onsuccess = (event) => {
                    allItems = event.target.result; // Cache items
                    updateGroupSuggestions(allItems);
                    renderItems(allItems);
                };
            }

            function renderItems(items) {
                const backNav = document.getElementById('back-nav-container');

                if (!items || items.length === 0) {
                    itemsGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fa-solid fa-box-open" style="font-size: 40px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <p>No items found.</p>
                        </div>
                    `;
                    backNav.style.display = searchInput.value ? 'none' : (activeGroup ? 'block' : 'none');
                    return;
                }

                // If searching, show flat list
                if (searchInput.value.trim() !== '') {
                    backNav.style.display = 'none';
                    items.forEach(item => addItemToDOM(item, itemsGrid));
                    return;
                }

                // Group Data Logic
                const groups = {};
                items.forEach(item => {
                    const groupName = item.group || 'General';
                    if (!groups[groupName]) groups[groupName] = [];
                    groups[groupName].push(item);
                });

                itemsGrid.innerHTML = ''; // Clear grid

                // Dashboard View (Show Group Cards)
                if (activeGroup === null) {
                    backNav.style.display = 'none';

                    Object.keys(groups).sort().forEach(groupName => {
                        const groupItems = groups[groupName];
                        const coverItem = groupItems.find(i => i.image) || groupItems[0];
                        const coverImage = coverItem && coverItem.image ? coverItem.image : 'https://placehold.co/600x400/1a1d24/FFF?text=Folder';

                        const card = document.createElement('div');
                        card.className = 'item-card'; // Reuse item card style
                        card.innerHTML = `
                             <img src="${coverImage}" class="card-image" style="opacity: 0.8;">
                             <div class="card-content">
                                 <div class="card-header">
                                     <h3 class="card-title"><i class="fa-solid fa-folder" style="color: var(--accent); margin-right: 8px;"></i>${groupName}</h3>
                                 </div>
                                 <p class="card-desc" style="margin-top: 5px;">${groupItems.length} items</p>
                             </div>
                        `;

                        card.onclick = () => {
                            activeGroup = groupName;
                            renderItems(allItems); // Re-render with active group
                        };

                        itemsGrid.appendChild(card);
                    });
                }
                // Group Detail View (Show Items in Group)
                else {
                    backNav.style.display = 'block';

                    // Filter items for active group
                    const groupItems = groups[activeGroup] || [];

                    if (groupItems.length === 0) {
                        activeGroup = null; // Reset if group empty/deleted
                        renderItems(allItems);
                        return;
                    }

                    // Sort items in group by ID descending
                    groupItems.sort((a, b) => b.id - a.id).forEach(item => {
                        addItemToDOM(item, itemsGrid);
                    });
                }
            }

            // Back Button Logic
            document.querySelector('#back-to-groups-btn').addEventListener('click', () => {
                activeGroup = null;
                searchInput.value = '';
                renderItems(allItems);
            });



            function updateGroupSuggestions(items) {
                const groups = new Set(items.map(i => i.group).filter(g => g));
                const datalist = document.getElementById('group-suggestions');
                datalist.innerHTML = '';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    datalist.appendChild(option);
                });
            }

            function addItemToDOM(item, container) {
                // Fallback if container not provided (for single add)
                if (!container) {
                    loadItems(); // Reload full view to handle grouping correctly
                    return;
                }

                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `

                    <img src="${item.image ? item.image : 'https://placehold.co/600x400/1a1d24/FFF?text=No+Image'}" alt="${item.name}" class="card-image">
                    <div class="card-content">
                        <div class="card-header">
                            <h3 class="card-title">${item.name}</h3>
                            <span class="card-price">₱${item.price.toFixed(2)}</span>
                        </div>
                        <p class="card-desc">${item.description || 'No description provided.'}</p>
                    </div>
                `;

                // Add View Functionality
                card.onclick = () => {
                    document.getElementById('view-name').textContent = item.name;
                    document.getElementById('view-price').textContent = '₱' + item.price.toFixed(2);
                    document.getElementById('view-description').textContent = item.description || 'No description provided.';

                    const groupEl = document.getElementById('view-group');
                    const groupCont = document.getElementById('view-group-container');
                    if (item.group) {
                        groupEl.textContent = item.group;
                        groupCont.style.display = 'block';
                    } else {
                        groupCont.style.display = 'none';
                    }


                    // Gallery Logic
                    const galleryContainer = document.getElementById('view-gallery');
                    galleryContainer.innerHTML = '';

                    const imagesList = item.images || (item.image ? [item.image] : []);
                    const mainImg = document.getElementById('view-image');

                    if (imagesList.length > 0) {
                        mainImg.src = imagesList[0];

                        // Render Thumbnails
                        imagesList.forEach((imgSrc) => {
                            const thumb = document.createElement('img');
                            thumb.src = imgSrc;
                            thumb.className = 'gallery-thumb';
                            if (imgSrc === imagesList[0]) thumb.classList.add('active');

                            thumb.onclick = () => {
                                mainImg.src = imgSrc;
                                document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
                                thumb.classList.add('active');
                            };

                            galleryContainer.appendChild(thumb);
                        });
                    } else {
                        mainImg.src = 'https://placehold.co/600x400/1a1d24/FFF?text=No+Image';
                    }

                    // Setup Actions
                    const deleteBtn = document.getElementById('view-delete-btn');
                    deleteBtn.onclick = () => {
                        if (!confirm('Are you sure you want to delete this item?')) return;
                        deleteItem(item.id);
                        document.getElementById('view-modal').classList.remove('active');
                    };

                    const editBtn = document.getElementById('view-edit-btn');
                    editBtn.onclick = () => {
                        document.getElementById('view-modal').classList.remove('active');
                        openEditModal(item);
                    };

                    document.getElementById('view-modal').classList.add('active');
                };



                container.insertBefore(card, container.firstChild);
            }

            function openEditModal(item) {
                editingId = item.id;
                editingCreated = item.created;

                // Populate Form
                document.getElementById('name').value = item.name;
                document.getElementById('price').value = item.price;
                document.getElementById('description').value = item.description;
                document.getElementById('group').value = item.group || '';

                // Populate Images
                currentImages = [];
                const imagesList = item.images || (item.image ? [item.image] : []);
                imagesList.forEach((imgData, idx) => {
                    currentImages.push({
                        data: imgData,
                        source: 'existing',
                        id: idx
                    });
                });
                renderPreviews();

                // Change UI to Edit Mode
                document.querySelector('#modal h2').textContent = 'Edit Item';
                addItemForm.querySelector('.btn-submit').textContent = 'Update Item';

                document.getElementById('modal').classList.add('active');
            }

            window.deleteItem = (id) => {
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);

                request.onsuccess = () => {
                    loadItems(); // Reload grid
                };
            };

            // --- Export / Import Logic ---

            exportBtn.addEventListener('click', () => {
                const transaction = db.transaction([STORE_NAME], "readonly");
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    const items = event.target.result;
                    const dataStr = JSON.stringify(items, null, 2);
                    const blob = new Blob([dataStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    const date = new Date().toISOString().slice(0, 10);
                    a.download = `collection_backup_${date}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
            });

            importFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importLabel.textContent = e.target.files[0].name;
                    importBtn.disabled = false;
                    importBtn.style.opacity = '1';
                    importBtn.style.cursor = 'pointer';
                }
            });

            importBtn.addEventListener('click', () => {
                const file = importFile.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const items = JSON.parse(e.target.result);
                        if (!Array.isArray(items)) throw new Error("Invalid format");

                        // Import Process
                        let successCount = 0;
                        const transaction = db.transaction([STORE_NAME], "readwrite");
                        const objectStore = transaction.objectStore(STORE_NAME);

                        items.forEach(item => {
                            // Remove ID to let DB generate new unique ones (avoids conflicts)
                            delete item.id;
                            objectStore.add(item);
                            successCount++;
                        });

                        transaction.oncomplete = () => {
                            alert(`Successfully restored ${successCount} items!`);
                            settingsModal.classList.remove('active');
                            loadItems(); // Refresh View
                            // Reset Input
                            importFile.value = '';
                            importLabel.textContent = 'Select Backup File to Restore...';
                            importBtn.disabled = true;
                            importBtn.style.opacity = '0.5';
                        };

                    } catch (err) {
                        alert("Failed to parse backup file. Please make sure it's a valid JSON file.");
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            });

            // Force Update Logic
            document.getElementById('force-update-btn').addEventListener('click', async () => {
                if (!confirm('This will refresh the app to get the latest updates. Your saved items will be safe. Continue?')) return;

                const btn = document.getElementById('force-update-btn');
                btn.textContent = 'Updating...';
                btn.disabled = true;

                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                    }
                }

                if ('caches' in window) {
                    const keys = await caches.keys();
                    for (const key of keys) {
                        await caches.delete(key);
                    }
                }

                window.location.reload(true);
            });

        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch((error) => console.log('Service Worker Registration Failed:', error));
        }
    </script>
</body>

</html>